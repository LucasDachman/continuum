{"ast":null,"code":"/**\n *  StartAudioContext.js\n *  @author Yotam Mann\n *  @license http://opensource.org/licenses/MIT MIT License\n *  @copyright 2016 Yotam Mann\n */\n(function (root, factory) {\n  if (typeof define === \"function\" && define.amd) {\n    define([], factory);\n  } else if (typeof module === \"object\" && module.exports) {\n    module.exports = factory();\n  } else {\n    root.StartAudioContext = factory();\n  }\n})(this, function () {\n  //TAP LISTENER/////////////////////////////////////////////////////////////\n\n  /**\n   * @class  Listens for non-dragging tap ends on the given element\n   * @param {Element} element\n   * @internal\n   */\n  var TapListener = function (element, context) {\n    this._dragged = false;\n    this._element = element;\n    this._bindedMove = this._moved.bind(this);\n    this._bindedEnd = this._ended.bind(this, context);\n    element.addEventListener(\"touchstart\", this._bindedEnd);\n    element.addEventListener(\"touchmove\", this._bindedMove);\n    element.addEventListener(\"touchend\", this._bindedEnd);\n    element.addEventListener(\"mouseup\", this._bindedEnd);\n  };\n  /**\n   * drag move event\n   */\n\n\n  TapListener.prototype._moved = function (e) {\n    this._dragged = true;\n  };\n  /**\n   * tap ended listener\n   */\n\n\n  TapListener.prototype._ended = function (context) {\n    if (!this._dragged) {\n      startContext(context);\n    }\n\n    this._dragged = false;\n  };\n  /**\n   * remove all the bound events\n   */\n\n\n  TapListener.prototype.dispose = function () {\n    this._element.removeEventListener(\"touchstart\", this._bindedEnd);\n\n    this._element.removeEventListener(\"touchmove\", this._bindedMove);\n\n    this._element.removeEventListener(\"touchend\", this._bindedEnd);\n\n    this._element.removeEventListener(\"mouseup\", this._bindedEnd);\n\n    this._bindedMove = null;\n    this._bindedEnd = null;\n    this._element = null;\n  }; //END TAP LISTENER/////////////////////////////////////////////////////////\n\n  /**\n   * Plays a silent sound and also invoke the \"resume\" method\n   * @param {AudioContext} context\n   * @private\n   */\n\n\n  function startContext(context) {\n    // this accomplishes the iOS specific requirement\n    var buffer = context.createBuffer(1, 1, context.sampleRate);\n    var source = context.createBufferSource();\n    source.buffer = buffer;\n    source.connect(context.destination);\n    source.start(0); // resume the audio context\n\n    if (context.resume) {\n      context.resume();\n    }\n  }\n  /**\n   * Returns true if the audio context is started\n   * @param  {AudioContext}  context\n   * @return {Boolean}\n   * @private\n   */\n\n\n  function isStarted(context) {\n    return context.state === \"running\";\n  }\n  /**\n   * Invokes the callback as soon as the AudioContext\n   * is started\n   * @param  {AudioContext}   context\n   * @param  {Function} callback\n   */\n\n\n  function onStarted(context, callback) {\n    function checkLoop() {\n      if (isStarted(context)) {\n        callback();\n      } else {\n        requestAnimationFrame(checkLoop);\n\n        if (context.resume) {\n          context.resume();\n        }\n      }\n    }\n\n    if (isStarted(context)) {\n      callback();\n    } else {\n      checkLoop();\n    }\n  }\n  /**\n   * Add a tap listener to the audio context\n   * @param  {Array|Element|String|jQuery} element\n   * @param {Array} tapListeners\n   */\n\n\n  function bindTapListener(element, tapListeners, context) {\n    if (Array.isArray(element) || NodeList && element instanceof NodeList) {\n      for (var i = 0; i < element.length; i++) {\n        bindTapListener(element[i], tapListeners, context);\n      }\n    } else if (typeof element === \"string\") {\n      bindTapListener(document.querySelectorAll(element), tapListeners, context);\n    } else if (element.jquery && typeof element.toArray === \"function\") {\n      bindTapListener(element.toArray(), tapListeners, context);\n    } else if (Element && element instanceof Element) {\n      //if it's an element, create a TapListener\n      var tap = new TapListener(element, context);\n      tapListeners.push(tap);\n    }\n  }\n  /**\n   * @param {AudioContext} context The AudioContext to start.\n   * @param {Array|String|Element|jQuery=} elements For iOS, the list of elements\n   *                                               to bind tap event listeners\n   *                                               which will start the AudioContext. If\n   *                                               no elements are given, it will bind\n   *                                               to the document.body.\n   * @param {Function=} callback The callback to invoke when the AudioContext is started.\n   * @return {Promise} The promise is invoked when the AudioContext\n   *                       is started.\n   */\n\n\n  function StartAudioContext(context, elements, callback) {\n    //the promise is invoked when the AudioContext is started\n    var promise = new Promise(function (success) {\n      onStarted(context, success);\n    }); // The TapListeners bound to the elements\n\n    var tapListeners = []; // add all the tap listeners\n\n    if (!elements) {\n      elements = document.body;\n    }\n\n    bindTapListener(elements, tapListeners, context); //dispose all these tap listeners when the context is started\n\n    promise.then(function () {\n      for (var i = 0; i < tapListeners.length; i++) {\n        tapListeners[i].dispose();\n      }\n\n      tapListeners = null;\n\n      if (callback) {\n        callback();\n      }\n    });\n    return promise;\n  }\n\n  return StartAudioContext;\n});","map":null,"metadata":{},"sourceType":"script"}